name: Publish Docs Articles To Wiki

on:
  schedule:
    # Sunday 21:30 UTC = Monday 01:30 Iran
    - cron: "30 21 * * 0"
  workflow_dispatch:

permissions:
  contents: write   # still needed for any local operations, but pushing to another repo requires a PAT

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clone destination Wiki (using PAT)
        run: |
          # Replace GH_PAT with your secret name that contains a personal access token
          # with write access to the target wiki repository.
          git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/intellsoft/AI-Product-FAQ.wiki.git wiki

      - name: Fetch source documentation index page
        run: |
          curl -L https://intellsoft.ir/docs/woocommerce-smart-product-qa-wordpress-plugin-guide/ -o index.html

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install beautifulsoup4 requests

      - name: Extract nav-link articles using Python
        run: |
          mkdir -p articles
          python3 - <<PYTHON
          import requests
          from bs4 import BeautifulSoup

          with open("index.html", encoding="utf-8") as f:
              soup = BeautifulSoup(f, "html.parser")

          links = soup.find_all("a", class_="nav-link")

          with open("articles/list.txt", "w", encoding="utf-8") as out:
              for a in links:
                  href = a.get("href")
                  title = a.get_text(strip=True)
                  if href and title:
                      out.write(f"{href}\t{title}\n")
          PYTHON

      - name: Publish new articles to Wiki
        run: |
          while IFS=$'\t' read -r url title; do
            slug=$(basename "$url")
            file="wiki/$slug.md"

            if [ -f "$file" ]; then
              echo "Already exists: $title"
              continue
            fi

            echo "Publishing: $title"

            curl -L "$url" -o article.html

            # Extract article content between <article> and </article>
            sed -n '/<article/,/<\/article>/p' article.html \
              | sed 's/<[^>]*>//g' > body.txt

            {
              echo "# $title"
              echo ""
              cat body.txt
              echo ""
              echo "---"
              echo "ðŸ”— **Ù…Ù†Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù…Ù‚Ø§Ù„Ù‡:**"
              echo ""
              echo "ðŸ‘‰ [$url]($url?utm_source=github_wiki&utm_medium=wiki&utm_campaign=woo_smart_qa_docs)"
            } > "$file"

          done < articles/list.txt

      - name: Commit and push to Wiki
        run: |
          cd wiki
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto publish new WooCommerce Smart Product QA documentation articles to Wiki" || exit 0
          git push
