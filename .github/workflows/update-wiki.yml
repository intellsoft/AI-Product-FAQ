name: Publish Docs to Wiki

on:
  schedule:
    - cron: "0 */6 * * *"   # Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq xmlstarlet curl

      - name: Clone wiki repository
        run: |
          git clone https://x-access-token:${{ secrets.WIKI_TOKEN }}@github.com/intellsoft/AI-Product-FAQ.wiki.git wiki

      - name: Read sitemap and filter target docs
        run: |
          mkdir -p articles

          curl -s https://intellsoft.ir/post-sitemap.xml \
          | xmlstarlet sel -t -m "//url/loc" -v . -n \
          | grep "^https://intellsoft.ir/docs/woocommerce-smart-product-qa-wordpress-plugin-guide/" \
          > articles/urls.txt

      - name: Fetch and publish new docs
        run: |
          while read -r url; do
            slug=$(basename "$url" | sed 's/[^a-zA-Z0-9\-]/-/g')
            file="wiki/${slug}.md"

            if [ -f "$file" ]; then
              echo "â­ Already exists: $slug"
              continue
            fi

            echo "ðŸ“¥ Fetching $url"

            content=$(curl -s "$url")

            echo "# $(basename "$url")" > "$file"
            echo "" >> "$file"
            echo "$content" >> "$file"

            echo "âœ… Published: $slug"
          done < articles/urls.txt

      - name: Commit and push to wiki
        run: |
          cd wiki
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Auto publish new docs from sitemap" || echo "No changes"
          git push
